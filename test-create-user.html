<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Cr√©ation Utilisateur - Diagnostic</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Courier New', monospace;
            background: #1a1a1a;
            color: #00ff00;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #0a0a0a;
            padding: 30px;
            border: 2px solid #00ff00;
            border-radius: 8px;
        }
        h1 { color: #00ff00; margin-bottom: 20px; }
        .section {
            margin: 20px 0;
            padding: 15px;
            background: #151515;
            border-left: 3px solid #00ff00;
        }
        .log {
            background: #000;
            padding: 15px;
            margin: 10px 0;
            border: 1px solid #333;
            overflow-x: auto;
            max-height: 400px;
            overflow-y: auto;
        }
        .log-item {
            margin: 5px 0;
            padding: 5px;
        }
        .log-item.info { color: #00bfff; }
        .log-item.success { color: #00ff00; }
        .log-item.error { color: #ff0000; }
        .log-item.warning { color: #ffa500; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 12px 24px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        button:hover { background: #00cc00; }
        input, select {
            background: #000;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 10px;
            margin: 5px 0;
            width: 100%;
            font-family: 'Courier New', monospace;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #00ff00;
        }
        code {
            background: #000;
            padding: 2px 6px;
            border: 1px solid #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî¨ Test Cr√©ation Utilisateur - Diagnostic Complet</h1>

        <div class="section">
            <h3>üìã Informations de connexion</h3>
            <div id="configInfo"></div>
        </div>

        <div class="section">
            <h3>1Ô∏è‚É£ Test de connexion Supabase</h3>
            <button onclick="testConnection()">Tester la connexion</button>
        </div>

        <div class="section">
            <h3>2Ô∏è‚É£ V√©rifier la structure de la table profiles</h3>
            <button onclick="checkTableStructure()">V√©rifier la table</button>
        </div>

        <div class="section">
            <h3>3Ô∏è‚É£ Cr√©er un utilisateur (avec logs d√©taill√©s)</h3>
            <div class="form-group">
                <label>Username</label>
                <input type="text" id="testUsername" value="test_user" placeholder="Username">
            </div>
            <div class="form-group">
                <label>Nom complet</label>
                <input type="text" id="testFullName" value="Utilisateur Test" placeholder="Nom complet">
            </div>
            <div class="form-group">
                <label>Mot de passe</label>
                <input type="password" id="testPassword" value="Test123!" placeholder="Mot de passe">
            </div>
            <div class="form-group">
                <label>R√¥le</label>
                <select id="testRole">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                </select>
            </div>
            <button onclick="createUser()">Cr√©er l'utilisateur</button>
            <button onclick="clearLogs()">Effacer les logs</button>
        </div>

        <div class="section">
            <h3>üìä Console de logs</h3>
            <div id="logs" class="log"></div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logsDiv = document.getElementById('logs');
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${timestamp}] ${message}`;
            logsDiv.appendChild(logItem);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        // Afficher la config
        document.getElementById('configInfo').innerHTML = `
            <p><strong>URL:</strong> <code>${SUPABASE_CONFIG.url}</code></p>
            <p><strong>Anon Key:</strong> <code>${SUPABASE_CONFIG.anonKey.substring(0, 30)}...</code></p>
        `;

        async function testConnection() {
            log('üîå Test de connexion √† Supabase...', 'info');

            try {
                const { data, error } = await supabaseClient.auth.getSession();

                if (error) {
                    log(`‚ùå Erreur de connexion: ${error.message}`, 'error');
                    return;
                }

                log('‚úÖ Connexion Supabase OK', 'success');
                log(`Session: ${data.session ? 'Connect√©' : 'Non connect√©'}`, 'info');
            } catch (err) {
                log(`‚ùå Exception: ${err.message}`, 'error');
            }
        }

        async function checkTableStructure() {
            log('üîç V√©rification de la structure de la table profiles...', 'info');

            try {
                // Essayer de r√©cup√©rer les colonnes en faisant une requ√™te
                const { data, error } = await supabaseClient
                    .from('profiles')
                    .select('*')
                    .limit(1);

                if (error) {
                    log(`‚ùå Erreur lors de la lecture de la table: ${error.message}`, 'error');
                    log(`Code: ${error.code}`, 'error');
                    log(`D√©tails: ${error.details}`, 'error');
                    return;
                }

                log('‚úÖ Table profiles accessible', 'success');

                if (data && data.length > 0) {
                    log(`üìä Colonnes d√©tect√©es: ${Object.keys(data[0]).join(', ')}`, 'info');
                } else {
                    log('‚ÑπÔ∏è Table vide, impossible de d√©tecter les colonnes', 'info');
                }
            } catch (err) {
                log(`‚ùå Exception: ${err.message}`, 'error');
            }
        }

        async function createUser() {
            const username = document.getElementById('testUsername').value.trim();
            const fullName = document.getElementById('testFullName').value.trim();
            const password = document.getElementById('testPassword').value;
            const role = document.getElementById('testRole').value;

            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');
            log('üöÄ D√âBUT DE LA CR√âATION D\'UTILISATEUR', 'info');
            log(`Username: ${username}`, 'info');
            log(`Full Name: ${fullName}`, 'info');
            log(`Role: ${role}`, 'info');
            log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'info');

            try {
                // √âTAPE 1 : V√©rifier si le username existe d√©j√†
                log('üìù √âtape 1: V√©rification username existant...', 'info');
                const { data: existingUser, error: checkError } = await supabaseClient
                    .from('profiles')
                    .select('username')
                    .eq('username', username)
                    .maybeSingle();

                if (checkError) {
                    log(`‚ùå Erreur v√©rification: ${checkError.message}`, 'error');
                    log(`Code: ${checkError.code}`, 'error');
                    return;
                }

                if (existingUser) {
                    log(`‚ö†Ô∏è Le username "${username}" existe d√©j√†`, 'warning');
                    return;
                }
                log('‚úÖ Username disponible', 'success');

                // √âTAPE 2 : Cr√©er l'email
                const email = `${username}@rapportcontrole.app`;
                log(`üìß √âtape 2: Email g√©n√©r√©: ${email}`, 'info');

                // √âTAPE 3 : Cr√©er le compte Auth
                log('üîê √âtape 3: Cr√©ation du compte Auth...', 'info');
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email,
                    password,
                    options: {
                        emailRedirectTo: undefined,
                        data: {
                            username: username,
                            full_name: fullName
                        }
                    }
                });

                if (authError) {
                    log(`‚ùå Erreur Auth: ${authError.message}`, 'error');
                    log(`Code Auth: ${authError.status}`, 'error');
                    log(`D√©tails Auth: ${JSON.stringify(authError)}`, 'error');
                    return;
                }

                if (!authData.user) {
                    log('‚ùå Aucun utilisateur cr√©√© dans Auth', 'error');
                    return;
                }

                log(`‚úÖ Compte Auth cr√©√© - UUID: ${authData.user.id}`, 'success');
                log(`Email confirm√©: ${authData.user.email_confirmed_at ? 'OUI' : 'NON'}`, 'info');

                // √âTAPE 4 : Attendre un peu
                log('‚è≥ √âtape 4: Attente de 1 seconde...', 'info');
                await new Promise(resolve => setTimeout(resolve, 1000));

                // √âTAPE 5 : Cr√©er le profil
                log('üë§ √âtape 5: Cr√©ation du profil...', 'info');
                log(`Donn√©es profil: id=${authData.user.id}, username=${username}, full_name=${fullName}, role=${role}`, 'info');

                const { data: profileData, error: profileError } = await supabaseClient
                    .from('profiles')
                    .insert([{
                        id: authData.user.id,
                        username,
                        full_name: fullName,
                        role
                    }])
                    .select();

                if (profileError) {
                    log(`‚ùå Erreur Profil: ${profileError.message}`, 'error');
                    log(`Code Profil: ${profileError.code}`, 'error');
                    log(`D√©tails Profil: ${profileError.details || 'N/A'}`, 'error');
                    log(`Hint Profil: ${profileError.hint || 'N/A'}`, 'error');
                    return;
                }

                log('‚úÖ Profil cr√©√© avec succ√®s!', 'success');
                log(`Donn√©es profil: ${JSON.stringify(profileData)}`, 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');
                log('üéâ UTILISATEUR CR√â√â AVEC SUCC√àS!', 'success');
                log('‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ', 'success');

            } catch (err) {
                log(`‚ùå Exception inattendue: ${err.message}`, 'error');
                log(`Stack: ${err.stack}`, 'error');
            }
        }

        // Log initial
        log('‚úÖ Page de diagnostic charg√©e', 'success');
        log('Cliquez sur les boutons pour lancer les tests', 'info');
    </script>
</body>
</html>
